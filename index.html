<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Levered Index Synthesizer</title>
<style>
  :root { --w: 1000px; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height: 1.35; margin: 0; color: #111; background: #fff; }
  header { padding: 16px; background: #f6f7f9; border-bottom: 1px solid #e5e7eb; }
  main { max-width: var(--w); margin: 0 auto; padding: 20px; }
  h1 { font-size: 20px; margin: 0 0 8px; }
  h2 { font-size: 16px; margin: 18px 0 10px; }
  .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin: 12px 0; }
  label { font-weight: 600; display: block; margin-bottom: 6px; }
  input, select, button { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; }
  button.primary { background: #111827; color: white; border-color: #111827; cursor: pointer; }
  button.ghost { background: white; color: #111827; border-color: #111827; cursor: pointer; }
  button:disabled { opacity: 0.6; cursor: not-allowed; }
  .note { font-size: 12px; color: #475569; margin-top: 4px; }
  .grid { overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 10px; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border-bottom: 1px solid #f1f5f9; padding: 8px; text-align: right; white-space: nowrap; }
  th { background: #f8fafc; text-align: left; }
  .muted { color: #475569; }
  .hidden { display: none; }
  .tag { font-size: 12px; background: #eef2ff; padding: 2px 6px; border-radius: 9999px; }
  .flex { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .center { display:flex; align-items:center; gap:12px; }
  footer { max-width: var(--w); margin: 16px auto 40px; padding: 0 20px; font-size: 12px; color: #475569; }
</style>
</head>
<body>
  <header>
    <h1>Levered Index Synthesizer</h1>
    <div class="muted">Build a UPRO-style series from daily index returns, applying a daily fee (from annual %) + extra drag, export CSV, and view trailing stats.</div>
  </header>

  <main>
    <section>
      <div class="row">
        <div>
          <label for="indexSel">Index</label>
          <select id="indexSel">
            <option value="^spx" selected>S&amp;P 500 (^SPX)</option>
            <option value="^dji">Dow Jones Industrial Average (^DJI)</option>
            <option value="custom">Custom (enter symbol)</option>
          </select>
          <div class="note">For custom, use the symbol format required by Alpha Vantage.</div>
        </div>
        <div id="customWrap" class="hidden">
          <label for="customSym">Custom Symbol</label>
          <input id="customSym" placeholder="e.g., ^spx or SPX" />
          <div class="note">Match the format required by Alpha Vantage.</div>
        </div>
        <div id="apiKeyWrap">
          <label for="apiKey">API Key</label>
          <input id="apiKey" placeholder="Required for Alpha Vantage" />
          <div class="note"><a href="https://www.alphavantage.co/support/#api-key" target="_blank" rel="noopener">Get a free API key</a>.</div>
        </div>
        <div>
          <label for="levSel">Leverage</label>
          <select id="levSel">
            <option value="2">2×</option>
            <option value="3" selected>3×</option>
            <option value="4">4×</option>
            <option value="5">5×</option>
          </select>
          <div class="note">Applied to the index’s <em>daily</em> return.</div>
        </div>
        <div>
          <label for="annFee">Annual Expense Ratio</label>
          <input id="annFee" type="number" step="0.0001" value="0.0091" placeholder="e.g., 0.0091" />
          <div class="note">Annual ratio in decimal (e.g., <code>0.0091</code>) converted to daily using 252 trading days.</div>
        </div>
        <div>
          <label for="drag">Extra Daily Drag</label>
          <input id="drag" type="number" step="0.00001" placeholder="e.g., 0.00005" />
          <div class="note">Optional daily extra drag, e.g., 0.00005–0.00020.</div>
        </div>
        <div>
          <label for="endDate">Metrics End Date (optional)</label>
          <input id="endDate" type="date" placeholder="YYYY-MM-DD" />
          <div class="note">Trailing windows end here; leave blank for latest date.</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="corsProxy">CORS Proxy (optional)</label>
          <input id="corsProxy" placeholder="https://cors.isomorphic-git.org/" />
          <div class="note">Use a CORS proxy if needed; leave blank to use the default.</div>
        </div>
        <div class="center">
          <button id="runBtn" class="primary">Fetch &amp; Compute</button>
          <button id="dlBtn" class="ghost" disabled>Download CSV</button>
          <span id="status" class="muted"></span>
        </div>
      </div>
    </section>

    <section id="summarySec" class="hidden">
      <h2>Summary</h2>
      <div class="flex">
        <div class="tag" id="summaryTag"></div>
        <div class="muted" id="feeInfo"></div>
      </div>
      <p class="muted">Returns use daily closes. Synthetic series starts at value 100 on its first row.</p>
      <div class="grid">
        <table id="metricsTbl">
          <thead>
            <tr>
              <th>Window</th>
              <th>Obs</th>
              <th>Avg (Index)</th>
              <th>Std Dev (Index)</th>
              <th>Avg (Synth)</th>
              <th>Std Dev (Synth)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="previewSec" class="hidden">
      <h2>Preview (last 10 rows)</h2>
      <div class="grid">
        <table id="previewTbl">
          <thead>
            <tr>
              <th style="text-align:left;">Date</th>
              <th>Index</th>
              <th>Levered Value</th>
              <th>RoR Index</th>
              <th>RoR Levered</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      </section>
      <!-- Additional data sources removed; Alpha Vantage only -->
    </main>

    <footer>
      Data from <a href="https://www.alphavantage.co/">Alpha Vantage</a>. Education/research use only.
    </footer>

<script>
const $ = sel => document.querySelector(sel);

const indexSel = $("#indexSel");
const customWrap = $("#customWrap");
const customSym = $("#customSym");
const apiKey = $("#apiKey");
const levSel = $("#levSel");
const annFee = $("#annFee");
const drag = $("#drag");
const endDate = $("#endDate");
const corsProxy = $("#corsProxy");
const runBtn = $("#runBtn");
const dlBtn = $("#dlBtn");
const statusEl = $("#status");

const summarySec = $("#summarySec");
const summaryTag = $("#summaryTag");
const feeInfo = $("#feeInfo");
const metricsTBody = $("#metricsTbl tbody");

const previewSec = $("#previewSec");
const previewTBody = $("#previewTbl tbody");

let lastCsvText = "";
let lastRows = [];

indexSel.addEventListener("change", () => {
  customWrap.classList.toggle("hidden", indexSel.value !== "custom");
});

async function fetchCsv(url) {
  async function get(u) {
    const res = await fetch(u);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.text();
  }
  try {
    return await get(url);
  } catch (e) {
    const userProxy = corsProxy.value.trim();
    const proxy = userProxy || "https://cors.isomorphic-git.org/";
    const proxied = proxy.endsWith("/") ? proxy + url : proxy + "/" + url;
    return await get(proxied);
  }
}

function toDailyFee(annual, tradingDays = 252) {
  return 1 - Math.pow(1 - annual, 1 / tradingDays);
}

function computeSeries(data, leverage, annualExpense, extraDrag) {
  // data sorted ascending by date; each item {date, close}
  if (data.length < 2) throw new Error("Not enough data points.");
  const feeDay = toDailyFee(annualExpense, 252);

  const out = [];
  let val = 100;
  let prev = data[0].close;

  out.push({ date: data[0].date, index: data[0].close, ror_index: 0, ror_lev: 0, lev_value: val });

  for (let i = 1; i < data.length; i++) {
    const px = data[i].close;
    const r = px / prev - 1;
    const pre = leverage * r;
    const post = (1 + pre) * (1 - feeDay) - 1 - (extraDrag || 0);
    val *= (1 + post);
    out.push({ date: data[i].date, index: px, ror_index: r, ror_lev: post, lev_value: val });
    prev = px;
  }

    return { rows: out, feeDay };
  }

  function parseAlphaVantageCsv(text) {
    const trimmed = text.trim();
    if (trimmed.startsWith("{")) {
      try {
        const obj = JSON.parse(trimmed);
        const msg = obj["Error Message"] || obj["Note"] || obj["Information"] || "Unexpected response from Alpha Vantage.";
        throw new Error(msg);
      } catch (e) {
        throw new Error("Unexpected response from Alpha Vantage.");
      }
    }
    const rows = trimmed.split(/\r?\n/).map(line => line.split(","));
    const header = rows.shift();
    const idxDate = header.indexOf("timestamp");
    let idxClose = header.indexOf("adjusted_close");
    if (idxClose === -1) idxClose = header.indexOf("close");
    if (idxDate === -1 || idxClose === -1) throw new Error("Unexpected CSV columns from Alpha Vantage.");
    return rows.map(cols => ({
      date: cols[idxDate],
      close: Number(cols[idxClose])
    })).filter(r => r.date && Number.isFinite(r.close));
  }

  function symbolFor(sym) {
    const s = sym.replace(/^\^/, "").toUpperCase();
    if (s === "SPX") return "SPY";
    if (s === "DJI") return "DIA";
    return s;
  }

  function toISODate(s) { return new Date(s + "T00:00:00Z"); }

function cagr(startVal, endVal, years) {
  if (startVal <= 0 || endVal <= 0 || years <= 0) return NaN;
  return Math.pow(endVal / startVal, 1 / years) - 1;
}

function mean(arr) {
  return arr.reduce((sum, v) => sum + v, 0) / arr.length;
}

function stdDev(arr) {
  if (arr.length < 2) return 0;
  const m = mean(arr);
  let s = 0;
  for (const v of arr) s += (v - m) ** 2;
  return Math.sqrt(s / (arr.length - 1));
}

function allCagrs(rows, years) {
  const idx = [], lev = [];
  for (let i = 0; i < rows.length; i++) {
    const start = rows[i];
    const startDate = toISODate(start.date);
    const endDate = new Date(startDate);
    endDate.setUTCFullYear(endDate.getUTCFullYear() + years);
    let j = i;
    while (j < rows.length && toISODate(rows[j].date) < endDate) j++;
    if (j >= rows.length) break;
    const end = rows[j];
    idx.push(cagr(start.index, end.index, years));
    lev.push(cagr(start.lev_value, end.lev_value, years));
  }
  return { idx, lev };
}

function fmtPct(x) { return Number.isFinite(x) ? (x * 100).toFixed(2) + "%" : "—"; }
function fmtNum(x) { return Number.isFinite(x) ? x.toLocaleString(undefined, { maximumFractionDigits: 6 }) : "—"; }

function buildCsv(rows) {
  const header = ["Date","index","leveraged_est_value","ror_index","ror_3x_est"];
  const lines = [header.join(",")];
  for (const r of rows) {
    lines.push([
      r.date,
      r.index,
      r.lev_value,
      r.ror_index,
      r.ror_lev
    ].join(","));
  }
  return lines.join("\n");
}

function populatePreview(rows) {
  previewTBody.innerHTML = "";
  const last = rows.slice(-10);
  for (const r of last) {
    const tr = document.createElement("tr");
    const cells = [r.date, fmtNum(r.index), fmtNum(r.lev_value), fmtNum(r.ror_index), fmtNum(r.ror_lev)];
    cells.forEach((v, i) => {
      const td = document.createElement("td");
      if (i === 0) td.style.textAlign = "left";
      td.textContent = v;
      tr.appendChild(td);
    });
    previewTBody.appendChild(tr);
  }
}

function populateMetrics(rows, feeDay, endISO) {
  summarySec.classList.remove("hidden");
  metricsTBody.innerHTML = "";

  const periods = [5, 10, 15, 20, 30];
  const endRow = endISO ? rows.find(r => r.date === endISO) : rows[rows.length - 1];
  const endDateStr = endRow.date;

  summaryTag.textContent = `End: ${endDateStr}`;
  const ann = Number(annFee.value);
  feeInfo.textContent = `Daily fee from annual ${(ann*100).toFixed(2)}% ≈ ${(feeDay*100).toFixed(3)} bps/day · Leverage ${levSel.value}×`;

  for (const y of periods) {
    const { idx, lev } = allCagrs(rows, y);
    if (idx.length === 0) continue;
    const tr = document.createElement("tr");
    const cells = [
      y + "y",
      idx.length,
      fmtPct(mean(idx)),
      fmtPct(stdDev(idx)),
      fmtPct(mean(lev)),
      fmtPct(stdDev(lev))
    ];
    cells.forEach(txt => {
      const td = document.createElement("td");
      td.textContent = txt;
      tr.appendChild(td);
    });
    metricsTBody.appendChild(tr);
  }
}

dlBtn.addEventListener("click", () => {
  if (!lastCsvText) return;
  const blob = new Blob([lastCsvText], { type: "text/csv;charset=utf-8" });
  const a = document.createElement("a");
  const idxLabel = (indexSel.value === "custom" ? (customSym.value || "custom") : indexSel.value).replace("%5E","^");
  a.href = URL.createObjectURL(blob);
  a.download = `synth_${idxLabel}_${levSel.value}x.csv`;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
});

runBtn.addEventListener("click", async () => {
  try {
    runBtn.disabled = true; dlBtn.disabled = true;
    summarySec.classList.add("hidden"); previewSec.classList.add("hidden");
    statusEl.textContent = "Fetching…";

      let sym = indexSel.value;
      if (sym === "custom") {
        const c = customSym.value.trim();
        if (!c) throw new Error("Enter a custom symbol.");
        sym = c;
      }
      sym = symbolFor(sym);
      const key = apiKey.value.trim();
      if (!key) throw new Error("Enter API key for Alpha Vantage.");
      const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${encodeURIComponent(sym)}&apikey=${key}&outputsize=full&datatype=csv`;
      const csv = await fetchCsv(url);
      const raw = parseAlphaVantageCsv(csv).sort((a,b) => a.date.localeCompare(b.date));
      if (raw.length < 2) throw new Error("Insufficient rows from Alpha Vantage.");

    // Clip to end date if provided
    const endStr = (endDate.value || "").trim();
    let data = raw, endISO = "";
    if (endStr) {
      const cut = new Date(endStr + "T00:00:00Z");
      data = raw.filter(r => new Date(r.date + "T00:00:00Z") <= cut);
      if (data.length < 2) throw new Error("End date too early—no data remains.");
      endISO = data[data.length - 1].date;
    }

    const leverage = Number(levSel.value);
    const annualExpense = Number(annFee.value || 0);
    const extraDrag = Number(drag.value || 0);

    const { rows, feeDay } = computeSeries(data, leverage, annualExpense, extraDrag);

    lastRows = rows;
    lastCsvText = buildCsv(rows);

    // UI
    previewTBody.innerHTML = "";
    populatePreview(rows);
    previewSec.classList.remove("hidden");
    populateMetrics(rows, feeDay, endISO);
    dlBtn.disabled = false;
    statusEl.textContent = `Done · ${rows.length.toLocaleString()} rows`;
  } catch (err) {
    console.error(err);
    statusEl.textContent = `Error: ${err.message}`;
  } finally {
    runBtn.disabled = false;
  }
});
</script>
</body>
</html>
